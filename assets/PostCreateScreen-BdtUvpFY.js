const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/title-V0kM41aT.js","assets/firebase-vendor-DDc4M5Fe.js","assets/index-yKJbQATM.js","assets/ui-vendor-JVI_EMCz.js","assets/react-vendor-Bzgz95E1.js","assets/index-CksgLseK.css","assets/imageUpload-CIfQ42AF.js"])))=>i.map(i=>d[i]);
import{r as R,j as u}from"./ui-vendor-JVI_EMCz.js";import{C as l,a as _,_ as Y,u as K,P as O,Q as Z,j as J,R as tt,k as et,S as ot}from"./index-yKJbQATM.js";import{c as f,q as b,l as U,o as $,f as st,w as k,a as w,h as v,i as E,d as m,s as j,T as rt,b as D,e as at,j as A}from"./firebase-vendor-DDc4M5Fe.js";import{b as nt}from"./imageUpload-CIfQ42AF.js";const M=async(a,o,t,r,s)=>{try{if(a===o)return;const n=`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,e=m(l,"users",a,"notifications",n),i={id:n,type:r,recipientId:a,actorId:o,actorName:t,isRead:!1,createdAt:new Date().toISOString()};s?.actorAvatar&&(i.actorAvatar=s.actorAvatar),s?.postId&&(i.postId=s.postId),s?.postContent&&(i.postContent=s.postContent),s?.commentId&&(i.commentId=s.commentId),s?.commentContent&&(i.commentContent=s.commentContent),await j(e,{...i,createdAt:rt.now()}),console.log("Notification created:",n)}catch(n){throw console.error("Error creating notification:",n),n}},ft=a=>{const o=new Map;return a.forEach(t=>{const r=t.postId?`${t.type}_${t.postId}`:`${t.type}_${t.actorId}`;if(o.has(r)){const s=o.get(r);s.actors.find(n=>n.id===t.actorId)||(s.actors.push({id:t.actorId,name:t.actorName,avatar:t.actorAvatar}),s.count++,new Date(t.createdAt)>new Date(s.latestNotification.createdAt)&&(s.latestNotification=t),t.isRead||(s.isRead=!1))}else o.set(r,{type:t.type,postId:t.postId,actors:[{id:t.actorId,name:t.actorName,avatar:t.actorAvatar}],latestNotification:t,count:1,isRead:t.isRead})}),Array.from(o.values()).sort((t,r)=>new Date(r.latestNotification.createdAt).getTime()-new Date(t.latestNotification.createdAt).getTime())},yt=async(a,o)=>{try{const t=m(l,"users",a,"notifications",o);await v(t,{isRead:!0})}catch(t){throw console.error("Error marking notification as read:",t),t}},wt=async a=>{try{const o=f(l,"users",a,"notifications"),t=b(o,k("isRead","==",!1)),s=(await w(t)).docs.map(n=>v(n.ref,{isRead:!0}));await Promise.all(s),console.log("All notifications marked as read")}catch(o){throw console.error("Error marking all notifications as read:",o),o}},Pt=async a=>{try{const o=f(l,"users",a,"notifications"),r=(await w(o)).docs.map(s=>E(s.ref));await Promise.all(r),console.log("All notifications deleted")}catch(o){throw console.error("Error deleting all notifications:",o),o}},vt=(a,o)=>{const t=f(l,"users",a,"notifications"),r=b(t,$("createdAt","desc"),U(50));return st(r,s=>{const n=[];s.forEach(e=>{const i=e.data();n.push({id:e.id,type:i.type,recipientId:i.recipientId,actorId:i.actorId,actorName:i.actorName,actorAvatar:i.actorAvatar,postId:i.postId,postContent:i.postContent,commentId:i.commentId,commentContent:i.commentContent,isRead:i.isRead||!1,createdAt:i.createdAt?.toDate?.()?.toISOString()||i.createdAt})}),o(n)},s=>{console.error("Error subscribing to notifications:",s),o([])})},bt=a=>{switch(a){case"like":return"‚ù§Ô∏è";case"comment":return"üí¨";case"repost":return"üîÅ";case"quote":return"üí≠";case"reply":return"‚Ü©Ô∏è";case"friend_request":return"ü§ù";case"friend_accept":return"‚úÖ";case"mention":return"@";default:return"üîî"}},xt=a=>{const{type:o,actors:t,count:r}=a;if(r===1){const s=t[0];switch(o){case"like":return`${s.name}„Åï„Çì„Åå„ÅÇ„Å™„Åü„ÅÆÊäïÁ®ø„Å´„ÅÑ„ÅÑ„Å≠„Åó„Åæ„Åó„Åü`;case"comment":return`${s.name}„Åï„Çì„Åå„ÅÇ„Å™„Åü„ÅÆÊäïÁ®ø„Å´„Ç≥„É°„É≥„Éà„Åó„Åæ„Åó„Åü`;case"repost":return`${s.name}„Åï„Çì„Åå„ÅÇ„Å™„Åü„ÅÆÊäïÁ®ø„Çí„É™„Éù„Çπ„Éà„Åó„Åæ„Åó„Åü`;case"quote":return`${s.name}„Åï„Çì„Åå„ÅÇ„Å™„Åü„ÅÆÊäïÁ®ø„ÇíÂºïÁî®„Åó„Åæ„Åó„Åü`;case"reply":return`${s.name}„Åï„Çì„Åå„ÅÇ„Å™„Åü„ÅÆÊäïÁ®ø„Å´Ëøî‰ø°„Åó„Åæ„Åó„Åü`;case"friend_request":return`${s.name}„Åï„Çì„Åã„Çâ„Éï„É¨„É≥„Éâ„É™„ÇØ„Ç®„Çπ„Éà„ÅåÂ±ä„Åç„Åæ„Åó„Åü`;case"friend_accept":return`${s.name}„Åï„Çì„Åå„Éï„É¨„É≥„Éâ„É™„ÇØ„Ç®„Çπ„Éà„ÇíÊâøË™ç„Åó„Åæ„Åó„Åü`;case"mention":return`${s.name}„Åï„Çì„Åå„ÅÇ„Å™„Åü„Çí„É°„É≥„Ç∑„Éß„É≥„Åó„Åæ„Åó„Åü`;default:return`${s.name}„Åï„Çì„Åã„ÇâÈÄöÁü•„Åå„ÅÇ„Çä„Åæ„Åô`}}else{const s=t[0],n=r-1;switch(o){case"like":return`${s.name}„Åï„Çì„Å®‰ªñ${n}‰∫∫„Åå„ÅÇ„Å™„Åü„ÅÆÊäïÁ®ø„Å´„ÅÑ„ÅÑ„Å≠„Åó„Åæ„Åó„Åü`;case"comment":return`${s.name}„Åï„Çì„Å®‰ªñ${n}‰∫∫„Åå„ÅÇ„Å™„Åü„ÅÆÊäïÁ®ø„Å´„Ç≥„É°„É≥„Éà„Åó„Åæ„Åó„Åü`;case"repost":return`${s.name}„Åï„Çì„Å®‰ªñ${n}‰∫∫„Åå„ÅÇ„Å™„Åü„ÅÆÊäïÁ®ø„Çí„É™„Éù„Çπ„Éà„Åó„Åæ„Åó„Åü`;case"quote":return`${s.name}„Åï„Çì„Å®‰ªñ${n}‰∫∫„Åå„ÅÇ„Å™„Åü„ÅÆÊäïÁ®ø„ÇíÂºïÁî®„Åó„Åæ„Åó„Åü`;case"reply":return`${s.name}„Åï„Çì„Å®‰ªñ${n}‰∫∫„Åå„ÅÇ„Å™„Åü„ÅÆÊäïÁ®ø„Å´Ëøî‰ø°„Åó„Åæ„Åó„Åü`;case"friend_request":return`${s.name}„Åï„Çì„Å®‰ªñ${n}‰∫∫„Åã„Çâ„Éï„É¨„É≥„Éâ„É™„ÇØ„Ç®„Çπ„Éà„ÅåÂ±ä„Åç„Åæ„Åó„Åü`;case"friend_accept":return`${s.name}„Åï„Çì„Å®‰ªñ${n}‰∫∫„Åå„Éï„É¨„É≥„Éâ„É™„ÇØ„Ç®„Çπ„Éà„ÇíÊâøË™ç„Åó„Åæ„Åó„Åü`;case"mention":return`${s.name}„Åï„Çì„Å®‰ªñ${n}‰∫∫„Åå„ÅÇ„Å™„Åü„Çí„É°„É≥„Ç∑„Éß„É≥„Åó„Åæ„Åó„Åü`;default:return`${s.name}„Åï„Çì„Å®‰ªñ${n}‰∫∫„Åã„ÇâÈÄöÁü•„Åå„ÅÇ„Çä„Åæ„Åô`}}},it=a=>{const o=/#[\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]+/g,t=a.match(o);return t?t.map(r=>r.slice(1)):[]},ct=a=>{const o=/@([a-zA-Z0-9_]+)/g,t=a.match(o);return t?[...new Set(t.map(r=>r.substring(1)))]:[]},lt=async a=>{try{const o=f(l,"users"),t=await w(o);for(const r of t.docs){const s=m(l,"users",r.id,"profile","data"),n=await D(s);if(n.exists()&&n.data().username===a)return r.id}return null}catch(o){return console.error("Error getting userId from username:",o),null}},P=a=>a?typeof a=="string"?a:a.toDate().toISOString():new Date().toISOString(),dt=async(a,o)=>{try{const t=await _(a);if(!t)throw new Error("„Éó„É≠„Éï„Ç£„Éº„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");const r=[];if(o.images&&o.images.length>0)for(const h of o.images){const y=await nt(a,h);r.push(y)}const s=it(o.content),n=ct(o.content),e=m(f(l,"posts")),i=e.id,c={id:i,content:o.content,images:r,authorId:a,authorName:t.displayName,authorAvatar:t.avatarUrl||"",likes:0,commentCount:0,repostCount:0,replyCount:0,hashtags:s,visibility:o.visibility,createdAt:at()};if(n.length>0&&(c.mentions=n),o.quotedPostId&&(c.quotedPostId=o.quotedPostId),o.replyToPostId&&(c.replyToPostId=o.replyToPostId,c.replyToUserId=o.replyToUserId,c.replyToUserName=o.replyToUserName),o.recipeData&&(c.recipeData=o.recipeData),await j(e,c),o.replyToPostId){const h=m(l,"posts",o.replyToPostId);await v(h,{replyCount:A(1)})}const g=m(l,"users",a,"profile","data");await v(g,{"stats.postCount":A(1)});try{const{checkAndGrantTitles:h}=await Y(async()=>{const{checkAndGrantTitles:y}=await import("./title-V0kM41aT.js");return{checkAndGrantTitles:y}},__vite__mapDeps([0,1,2,3,4,5,6]));await h(a)}catch(h){console.error("Áß∞Âè∑„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:",h)}if(n.length>0)for(const h of n){const y=await lt(h);y&&y!==a&&await M(y,a,t.displayName,"mention",{actorAvatar:t.avatarUrl,postId:i,postContent:o.content})}return console.log("ÊäïÁ®ø„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü:",i),i}catch(t){throw console.error("ÊäïÁ®ø„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),t}},C=async a=>{try{const o=m(l,"posts",a),t=await D(o);if(!t.exists())return null;const r=t.data();let s;if(r.quotedPostId){const n=await C(r.quotedPostId);n&&(s=n)}return{id:t.id,content:r.content,images:r.images||[],authorId:r.authorId,authorName:r.authorName,authorAvatar:r.authorAvatar||"",likes:r.likes||0,commentCount:r.commentCount||0,repostCount:r.repostCount||0,replyCount:r.replyCount||0,hashtags:r.hashtags||[],mentions:r.mentions||[],quotedPostId:r.quotedPostId,quotedPost:s,replyToPostId:r.replyToPostId,replyToUserId:r.replyToUserId,replyToUserName:r.replyToUserName,recipeData:r.recipeData,visibility:r.visibility,isPinned:r.isPinned||!1,createdAt:P(r.createdAt),updatedAt:r.updatedAt?P(r.updatedAt):void 0}}catch(o){return console.error("ÊäïÁ®ø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",o),null}},ut=async(a,o=20)=>{try{console.log(`[getUserPosts] Fetching posts for user: ${a}`);const t=f(l,"posts");let r;try{const n=b(t,k("authorId","==",a),$("createdAt","desc"),U(o));console.log("[getUserPosts] Executing query with index..."),r=await w(n)}catch{console.warn("[getUserPosts] Index not found, using fallback query...");const e=b(t,k("authorId","==",a)),c=(await w(e)).docs.sort((g,h)=>{const y=g.data().createdAt,p=h.data().createdAt;return!y||!p?0:p.seconds-y.seconds});r={docs:c.slice(0,o),empty:c.length===0,size:Math.min(c.length,o)}}console.log(`[getUserPosts] Query returned ${r.docs.length} documents`);const s=[];for(const n of r.docs){const e=n.data();let i;if(e.quotedPostId){const c=await C(e.quotedPostId);c&&(i={...c,quotedPost:void 0})}s.push({id:n.id,content:e.content,images:e.images||[],authorId:e.authorId,authorName:e.authorName,authorAvatar:e.authorAvatar||"",likes:e.likes||0,commentCount:e.commentCount||0,repostCount:e.repostCount||0,replyCount:e.replyCount||0,hashtags:e.hashtags||[],mentions:e.mentions||[],quotedPostId:e.quotedPostId,quotedPost:i,replyToPostId:e.replyToPostId,replyToUserId:e.replyToUserId,replyToUserName:e.replyToUserName,recipeData:e.recipeData,visibility:e.visibility,isPinned:e.isPinned||!1,createdAt:P(e.createdAt),updatedAt:e.updatedAt?P(e.updatedAt):void 0})}return console.log(`[getUserPosts] Successfully processed ${s.length} posts`),s}catch(t){return console.error("[getUserPosts] „É¶„Éº„Ç∂„Éº„ÅÆÊäïÁ®øÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),[]}},kt=async(a=20)=>{console.log("üîç getTimelinePosts: Starting to fetch timeline posts...");try{const o=f(l,"posts");console.log("üìÅ getTimelinePosts: Creating query with visibility=public, orderBy createdAt desc");const t=b(o,k("visibility","==","public"),$("createdAt","desc"),U(a));console.log("‚ö° getTimelinePosts: Executing query...");const r=await w(t);console.log(`üìä getTimelinePosts: Query returned ${r.size} documents`);const s=[];for(const n of r.docs){const e=n.data();console.log(`üìÑ Processing post ${n.id}:`,{authorId:e.authorId,authorName:e.authorName,visibility:e.visibility,createdAt:e.createdAt});let i;if(e.quotedPostId){const c=await C(e.quotedPostId);c&&(i={...c,quotedPost:void 0})}s.push({id:n.id,content:e.content,images:e.images||[],authorId:e.authorId,authorName:e.authorName,authorAvatar:e.authorAvatar||"",likes:e.likes||0,commentCount:e.commentCount||0,repostCount:e.repostCount||0,replyCount:e.replyCount||0,hashtags:e.hashtags||[],mentions:e.mentions||[],quotedPostId:e.quotedPostId,quotedPost:i,replyToPostId:e.replyToPostId,replyToUserId:e.replyToUserId,replyToUserName:e.replyToUserName,recipeData:e.recipeData,visibility:e.visibility,isPinned:e.isPinned||!1,createdAt:P(e.createdAt),updatedAt:e.updatedAt?P(e.updatedAt):void 0})}return console.log(`‚úÖ getTimelinePosts: Successfully processed ${s.length} posts`),s}catch(o){if(console.error("‚ùå getTimelinePosts: Error occurred:",o),console.error("Error code:",o.code),console.error("Error message:",o.message),o.code==="failed-precondition"&&o.message?.includes("index")){console.warn("‚ö†Ô∏è Firestore„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅåÊú™‰ΩúÊàê„Åß„Åô„ÄÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÇØ„Ç®„É™„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ"),console.warn("„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàêURL:",o.message);try{console.log("üîÑ getTimelinePosts: Trying fallback query (orderBy createdAt only)...");const t=f(l,"posts"),r=b(t,$("createdAt","desc"),U(a*3)),s=await w(r);console.log(`üìä Fallback query returned ${s.size} documents`);const n=[];for(const i of s.docs){const c=i.data();let g;if(c.quotedPostId){const h=await C(c.quotedPostId);h&&(g={...h,quotedPost:void 0})}n.push({id:i.id,content:c.content,images:c.images||[],authorId:c.authorId,authorName:c.authorName,authorAvatar:c.authorAvatar||"",likes:c.likes||0,commentCount:c.commentCount||0,repostCount:c.repostCount||0,hashtags:c.hashtags||[],mentions:c.mentions||[],quotedPostId:c.quotedPostId,quotedPost:g,recipeData:c.recipeData,visibility:c.visibility,createdAt:P(c.createdAt),updatedAt:c.updatedAt?P(c.updatedAt):void 0})}const e=n.filter(i=>i.visibility==="public").slice(0,a);return console.log(`‚úÖ Fallback: Filtered to ${e.length} public posts`),e}catch(t){return console.error("‚ùå „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÇØ„Ç®„É™„ÇÇ„Ç®„É©„Éº:",t),console.error("Fallback error code:",t.code),console.error("Fallback error message:",t.message),[]}}return console.error("‚ùå „Çø„Ç§„É†„É©„Ç§„É≥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºàË©≥Á¥∞Ôºâ:",o),[]}},At=async(a,o)=>{try{const t=await C(a);if(!t)throw new Error("ÊäïÁ®ø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");if(t.authorId!==o)throw new Error("Ëá™ÂàÜ„ÅÆÊäïÁ®ø„ÅÆ„ÅøÂâäÈô§„Åß„Åç„Åæ„Åô");if(t.replyToPostId){const n=m(l,"posts",t.replyToPostId);await v(n,{replyCount:A(-1)})}const r=m(l,"posts",a);await E(r);const s=m(l,"users",o,"profile","data");await v(s,{"stats.postCount":A(-1)}),console.log("ÊäïÁ®ø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü:",a)}catch(t){throw console.error("ÊäïÁ®ø„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),t}},It=async(a,o,t,r)=>{try{const s=m(f(l,`posts/${a}/likes`)),e={id:s.id,postId:a,userId:o,userName:t,createdAt:new Date().toISOString()};r&&(e.userAvatar=r),await j(s,e);const i=m(l,"posts",a);await v(i,{likes:A(1)});const c=await D(i);if(c.exists()){const g=c.data();await M(g.authorId,o,t,"like",{actorAvatar:r,postId:a,postContent:g.content})}console.log("„ÅÑ„ÅÑ„Å≠„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü")}catch(s){throw console.error("„ÅÑ„ÅÑ„Å≠„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",s),s}},Ct=async(a,o)=>{try{const t=f(l,`posts/${a}/likes`),r=b(t,k("userId","==",o)),s=await w(r);for(const e of s.docs)await E(e.ref);const n=m(l,"posts",a);await v(n,{likes:A(-1)}),console.log("„ÅÑ„ÅÑ„Å≠„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü")}catch(t){throw console.error("„ÅÑ„ÅÑ„Å≠„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),t}},Tt=async(a,o)=>{try{const t=f(l,`posts/${a}/likes`),r=b(t,k("userId","==",o));return!(await w(r)).empty}catch(t){return console.error("„ÅÑ„ÅÑ„Å≠Á¢∫Ë™ç„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),!1}},qt=async(a,o,t,r,s)=>{try{const n=m(f(l,`posts/${a}/comments`)),i={id:n.id,postId:a,userId:o,userName:t,content:r,createdAt:new Date().toISOString()};s&&(i.userAvatar=s),await j(n,i);const c=m(l,"posts",a);await v(c,{commentCount:A(1)});const g=await D(c);if(g.exists()){const h=g.data();await M(h.authorId,o,t,"comment",{actorAvatar:s,postId:a,postContent:h.content,commentContent:r})}console.log("„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü")}catch(n){throw console.error("„Ç≥„É°„É≥„Éà„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",n),n}},Rt=async(a,o,t)=>{try{const r=m(l,`posts/${a}/comments/${o}`),s=await D(r);if(!s.exists())throw new Error("„Ç≥„É°„É≥„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");if(s.data().userId!==t)throw new Error("Ëá™ÂàÜ„ÅÆ„Ç≥„É°„É≥„Éà„ÅÆ„ÅøÂâäÈô§„Åß„Åç„Åæ„Åô");await E(r);const n=m(l,"posts",a);await v(n,{commentCount:A(-1)}),console.log("„Ç≥„É°„É≥„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü")}catch(r){throw console.error("„Ç≥„É°„É≥„Éà„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",r),r}},St=async a=>{try{const o=f(l,`posts/${a}/comments`),t=b(o,$("createdAt","asc")),r=await w(t),s=[];return r.forEach(n=>{const e=n.data();s.push({id:n.id,postId:a,userId:e.userId,userName:e.userName,userAvatar:e.userAvatar,content:e.content,createdAt:e.createdAt,updatedAt:e.updatedAt})}),s}catch(o){return console.error("„Ç≥„É°„É≥„Éà‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",o),[]}},$t=async(a,o)=>{try{const t=m(l,`users/${o}/bookmarks/${a}`),r={id:a,postId:a,userId:o,createdAt:new Date().toISOString()};await j(t,r),console.log("„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü")}catch(t){throw console.error("„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),t}},Ut=async(a,o)=>{try{const t=m(l,`users/${o}/bookmarks/${a}`);await E(t),console.log("„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü")}catch(t){throw console.error("„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),t}},Dt=async(a,o)=>{try{const t=m(l,`users/${o}/bookmarks/${a}`);return(await D(t)).exists()}catch(t){return console.error("„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÁ¢∫Ë™ç„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),!1}},Nt=async(a,o,t,r)=>{try{const s=m(f(l,`posts/${a}/reposts`)),e={id:s.id,postId:a,userId:o,userName:t,createdAt:new Date().toISOString()};r&&(e.userAvatar=r),await j(s,e);const i=m(l,"posts",a);await v(i,{repostCount:A(1)});const c=await D(i);if(c.exists()){const g=c.data();await M(g.authorId,o,t,"repost",{actorAvatar:r,postId:a,postContent:g.content})}console.log("„É™„Éù„Çπ„Éà„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü")}catch(s){throw console.error("„É™„Éù„Çπ„Éà„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",s),s}},Et=async(a,o)=>{try{const t=f(l,`posts/${a}/reposts`),r=b(t,k("userId","==",o)),s=await w(r);for(const e of s.docs)await E(e.ref);const n=m(l,"posts",a);await v(n,{repostCount:A(-1)}),console.log("„É™„Éù„Çπ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü")}catch(t){throw console.error("„É™„Éù„Çπ„Éà„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),t}},jt=async(a,o)=>{try{const t=f(l,`posts/${a}/reposts`),r=b(t,k("userId","==",o));return!(await w(r)).empty}catch(t){return console.error("„É™„Éù„Çπ„ÉàÁ¢∫Ë™ç„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),!1}},Ft=async(a=10)=>{try{const o=f(l,"posts"),t=b(o,k("visibility","==","public"),U(200)),r=await w(t),s=[];return r.forEach(n=>{const e=n.data(),i=e.likes||0;s.push({id:n.id,content:e.content,images:e.images||[],authorId:e.authorId,authorName:e.authorName,authorAvatar:e.authorAvatar||"",likes:i,commentCount:e.commentCount||0,repostCount:e.repostCount||0,hashtags:e.hashtags||[],visibility:e.visibility,createdAt:P(e.createdAt),updatedAt:e.updatedAt?P(e.updatedAt):void 0})}),s.sort((n,e)=>e.likes-n.likes),s.slice(0,a)}catch(o){return console.error("„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",o),o instanceof Error&&(console.error("„Ç®„É©„ÉºË©≥Á¥∞:",o.message),console.error("„Çπ„Çø„ÉÉ„ÇØ:",o.stack)),[]}},zt=async(a=10)=>{try{const o=f(l,"recipes"),t=b(o,k("visibility","==","public"),U(200)),r=await w(t),s=[];return r.forEach(n=>{const e=n.data(),i=e.likes||0;s.push({id:n.id,title:e.title,description:e.description,ingredients:e.ingredients,instructions:e.instructions,difficulty:e.difficulty,servings:e.servings,preparationTime:e.preparationTime,cookingTime:e.cookingTime,imageUrl:e.imageUrl,authorId:e.authorId,authorName:e.authorName,authorAvatar:e.authorAvatar,likes:i,commentCount:e.commentCount||0,visibility:e.visibility,createdAt:e.createdAt,updatedAt:e.updatedAt})}),s.sort((n,e)=>(e.likes||0)-(n.likes||0)),s.slice(0,a)}catch(o){return console.error("„É¨„Ç∑„Éî„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",o),o instanceof Error&&(console.error("„Ç®„É©„ÉºË©≥Á¥∞:",o.message),console.error("„Çπ„Çø„ÉÉ„ÇØ:",o.stack)),[]}},Mt=async(a,o=20)=>{try{console.log(`[getFollowingPosts] Fetching following posts for user: ${a}`);const t=[];if(console.log(`[getFollowingPosts] Found ${t.length} following users`),t.length===0)return[];const r=t.map(i=>i.uid),s=f(l,"posts"),n=[];for(let i=0;i<r.length;i+=10){const c=r.slice(i,i+10),g=b(s,k("authorId","in",c),k("visibility","in",["public","followers"])),h=await w(g);for(const y of h.docs){const p=y.data();let T;if(p.quotedPostId){const N=await C(p.quotedPostId);N&&(T={...N,quotedPost:void 0})}n.push({id:y.id,content:p.content,images:p.images||[],authorId:p.authorId,authorName:p.authorName,authorAvatar:p.authorAvatar||"",likes:p.likes||0,commentCount:p.commentCount||0,repostCount:p.repostCount||0,replyCount:p.replyCount||0,hashtags:p.hashtags||[],mentions:p.mentions||[],quotedPostId:p.quotedPostId,quotedPost:T,replyToPostId:p.replyToPostId,replyToUserId:p.replyToUserId,replyToUserName:p.replyToUserName,recipeData:p.recipeData,visibility:p.visibility,isPinned:p.isPinned||!1,createdAt:P(p.createdAt),updatedAt:p.updatedAt?P(p.updatedAt):void 0})}}n.sort((i,c)=>new Date(c.createdAt).getTime()-new Date(i.createdAt).getTime());const e=n.slice(0,o);return console.log(`[getFollowingPosts] Returning ${e.length} posts`),e}catch(t){return console.error("[getFollowingPosts] „Éï„Ç©„É≠„Éº‰∏≠„ÅÆÊäïÁ®øÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),[]}},Bt=async(a,o=20)=>{try{console.log(`[getUserMediaPosts] Fetching media posts for user: ${a}`);const r=(await ut(a,100)).filter(s=>s.images&&s.images.length>0);return console.log(`[getUserMediaPosts] Found ${r.length} media posts`),r.slice(0,o)}catch(t){return console.error("[getUserMediaPosts] „É°„Éá„Ç£„Ç¢ÊäïÁ®ø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),[]}},_t=async(a,o=20)=>{try{console.log(`[getUserLikedPosts] Fetching liked posts for user: ${a}`);const t=f(l,"posts"),r=await w(t),s=[];for(const n of r.docs){const e=n.data(),i=f(l,`posts/${n.id}/likes`),c=await w(i);let g=!1;for(const h of c.docs)if(h.data().userId===a){g=!0;break}if(g){let h;if(e.quotedPostId){const y=await C(e.quotedPostId);y&&(h={...y,quotedPost:void 0})}s.push({id:n.id,content:e.content,images:e.images||[],authorId:e.authorId,authorName:e.authorName,authorAvatar:e.authorAvatar||"",likes:e.likes||0,commentCount:e.commentCount||0,repostCount:e.repostCount||0,replyCount:e.replyCount||0,hashtags:e.hashtags||[],mentions:e.mentions||[],quotedPostId:e.quotedPostId,quotedPost:h,replyToPostId:e.replyToPostId,replyToUserId:e.replyToUserId,replyToUserName:e.replyToUserName,recipeData:e.recipeData,visibility:e.visibility,isPinned:e.isPinned||!1,createdAt:P(e.createdAt),updatedAt:e.updatedAt?P(e.updatedAt):void 0})}if(s.length>=o)break}return s.sort((n,e)=>new Date(e.createdAt).getTime()-new Date(n.createdAt).getTime()),console.log(`[getUserLikedPosts] Found ${s.length} liked posts`),s.slice(0,o)}catch(t){return console.error("[getUserLikedPosts] „ÅÑ„ÅÑ„Å≠„Åó„ÅüÊäïÁ®ø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",t),[]}},Lt=async(a,o)=>{try{console.log(`[pinPost] Pinning post ${o} for user ${a}`);const t=await C(o);if(!t)throw new Error("ÊäïÁ®ø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");if(t.authorId!==a)throw new Error("Ëá™ÂàÜ„ÅÆÊäïÁ®ø„ÅÆ„Åø„Éî„É≥Áïô„ÇÅ„Åß„Åç„Åæ„Åô");const r=m(l,`users/${a}/profile/data`),s=await D(r);if(s.exists()){const i=s.data().pinnedPostId;if(i){const c=m(l,"posts",i);await v(c,{isPinned:!1})}}await v(r,{pinnedPostId:o});const n=m(l,"posts",o);await v(n,{isPinned:!0}),console.log(`‚úÖ [pinPost] Post ${o} pinned successfully`)}catch(t){throw console.error("‚ùå [pinPost] Error:",t),new Error(`„Éî„É≥Áïô„ÇÅ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${t.message||"‰∏çÊòé„Å™„Ç®„É©„Éº"}`)}},Ot=async(a,o)=>{try{console.log(`[unpinPost] Unpinning post ${o} for user ${a}`);const t=m(l,`users/${a}/profile/data`);await v(t,{pinnedPostId:null});const r=m(l,"posts",o);await v(r,{isPinned:!1}),console.log(`‚úÖ [unpinPost] Post ${o} unpinned successfully`)}catch(t){throw console.error("‚ùå [unpinPost] Error:",t),new Error(`„Éî„É≥Áïô„ÇÅËß£Èô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${t.message||"‰∏çÊòé„Å™„Ç®„É©„Éº"}`)}},Qt=async(a,o=20)=>{try{console.log(`[getUserReplies] Fetching replies for user: ${a}`);const t=f(l,"posts"),r=b(t,k("authorId","==",a),k("replyToPostId","!=",null),$("replyToPostId"),$("createdAt","desc"),U(o)),s=await w(r),n=[];for(const e of s.docs){const i=e.data(),c={id:e.id,content:i.content,images:i.images||[],authorId:i.authorId,authorName:i.authorName,authorAvatar:i.authorAvatar||"",likes:i.likes||0,commentCount:i.commentCount||0,repostCount:i.repostCount||0,replyCount:i.replyCount||0,hashtags:i.hashtags||[],mentions:i.mentions||[],quotedPostId:i.quotedPostId,replyToPostId:i.replyToPostId,replyToUserId:i.replyToUserId,replyToUserName:i.replyToUserName,recipeData:i.recipeData,visibility:i.visibility,isPinned:i.isPinned||!1,createdAt:P(i.createdAt),updatedAt:i.updatedAt?P(i.updatedAt):void 0};n.push(c)}return console.log(`[getUserReplies] Found ${n.length} replies`),n}catch(t){console.error("[getUserReplies] Error:",t);try{const r=f(l,"posts"),s=b(r,k("authorId","==",a),$("createdAt","desc"),U(o)),n=await w(s),e=[];for(const i of n.docs){const c=i.data();if(c.replyToPostId){const g={id:i.id,content:c.content,images:c.images||[],authorId:c.authorId,authorName:c.authorName,authorAvatar:c.authorAvatar||"",likes:c.likes||0,commentCount:c.commentCount||0,repostCount:c.repostCount||0,replyCount:c.replyCount||0,hashtags:c.hashtags||[],mentions:c.mentions||[],quotedPostId:c.quotedPostId,replyToPostId:c.replyToPostId,replyToUserId:c.replyToUserId,replyToUserName:c.replyToUserName,recipeData:c.recipeData,visibility:c.visibility,isPinned:c.isPinned||!1,createdAt:P(c.createdAt),updatedAt:c.updatedAt?P(c.updatedAt):void 0};e.push(g)}}return console.log(`[getUserReplies] Fallback: Found ${e.length} replies`),e.slice(0,o)}catch(r){return console.error("[getUserReplies] Fallback also failed:",r),[]}}},S=280,z=4,Wt=({onClose:a,onPostCreated:o,quotedPostId:t,recipeData:r})=>{const{user:s}=K(),[n,e]=R.useState(""),[i,c]=R.useState([]),[g,h]=R.useState([]),[y,p]=R.useState("public"),[T,N]=R.useState(!1),[L,q]=R.useState(""),[F,Q]=R.useState(null);R.useEffect(()=>{(async()=>{if(t){const x=await C(t);Q(x)}})()},[t]);const W=d=>{const x=Array.from(d.target.files||[]);if(x.length===0)return;if(i.length+x.length>z){q(`ÁîªÂÉè„ÅØÊúÄÂ§ß${z}Êûö„Åæ„ÅßÊ∑ª‰ªò„Åß„Åç„Åæ„Åô`);return}const I=[];x.forEach(X=>{const B=new FileReader;B.onloadend=()=>{I.push(B.result),I.length===x.length&&h([...g,...I])},B.readAsDataURL(X)}),c([...i,...x]),q("")},H=d=>{c(i.filter((x,I)=>I!==d)),h(g.filter((x,I)=>I!==d))},G=async()=>{if(!s){q("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ");return}if(!n.trim()){q("ÊäïÁ®øÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");return}if(n.length>S){q(`ÊäïÁ®ø„ÅØ${S}ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`);return}N(!0),q("");try{console.log("üìù Checking user profile before posting...");let d=await _(s.uid);if(!d){console.log("‚ö†Ô∏è „Éó„É≠„Éï„Ç£„Éº„É´„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì„ÄÇËá™Âãï‰ΩúÊàê„Åó„Åæ„Åô...");try{await ot(s.uid,s.email||"",s.displayName||`User${s.uid.slice(0,8)}`),console.log("‚úÖ „Éó„É≠„Éï„Ç£„Éº„É´„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü"),d=await _(s.uid)}catch(I){console.error("‚ùå „Éó„É≠„Éï„Ç£„Éº„É´‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",I),q("„Éó„É≠„Éï„Ç£„Éº„É´‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇË®≠ÂÆöÁîªÈù¢„Åã„Çâ„Éó„É≠„Éï„Ç£„Éº„É´„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"),N(!1);return}}const x={content:n.trim(),images:i,visibility:y,quotedPostId:t,recipeData:r};await dt(s.uid,x),alert("ÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅ"),o(),a()}catch(d){console.error("ÊäïÁ®ø„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:",d),q("ÊäïÁ®ø„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ")}finally{N(!1)}},V=[{value:"public",label:"ÂÖ®‰ΩìÂÖ¨Èñã",icon:J,description:"Ë™∞„Åß„ÇÇË¶ã„Çâ„Çå„Åæ„Åô"},{value:"followers",label:"„Éï„Ç©„É≠„ÉØ„Éº",icon:tt,description:"„Éï„Ç©„É≠„ÉØ„Éº„ÅÆ„Åø"},{value:"private",label:"ÈùûÂÖ¨Èñã",icon:et,description:"Ëá™ÂàÜ„ÅÆ„Åø"}];return u.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.5)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:1e3,padding:"16px"},onClick:a,children:u.jsxs("div",{style:{background:"var(--card)",borderRadius:"16px",width:"100%",maxWidth:"600px",maxHeight:"90vh",overflow:"auto",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.2)"},onClick:d=>d.stopPropagation(),children:[u.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"16px 20px",borderBottom:"1px solid var(--border)"},children:[u.jsx("h2",{style:{fontSize:"20px",fontWeight:600,color:"var(--text)",margin:0},children:"ÊäïÁ®ø„Çí‰ΩúÊàê"}),u.jsx("button",{onClick:a,style:{background:"none",border:"none",cursor:"pointer",padding:"8px",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--text-secondary)",transition:"background 0.2s"},onMouseEnter:d=>{d.currentTarget.style.background="var(--border)"},onMouseLeave:d=>{d.currentTarget.style.background="none"},children:u.jsx(O,{size:24})})]}),u.jsxs("div",{style:{padding:"20px"},children:[u.jsx("textarea",{value:n,onChange:d=>e(d.target.value),placeholder:"‰ªä‰Ωï„Åó„Å¶„ÇãÔºü",style:{width:"100%",minHeight:"120px",padding:"12px",border:"2px solid var(--border)",borderRadius:"12px",fontSize:"16px",color:"var(--text)",background:"var(--background)",resize:"vertical",fontFamily:"inherit",marginBottom:"12px"}}),F&&u.jsxs("div",{style:{padding:"12px",background:"var(--background)",border:"1px solid var(--border)",borderRadius:"12px",marginBottom:"12px"},children:[u.jsx("div",{style:{fontSize:"14px",color:"var(--text-secondary)",marginBottom:"8px"},children:"ÂºïÁî®ÂÖÉ:"}),u.jsx("div",{style:{fontWeight:600,fontSize:"14px",color:"var(--text)"},children:F.authorName}),u.jsxs("div",{style:{fontSize:"14px",color:"var(--text)",marginTop:"4px"},children:[F.content.substring(0,100),F.content.length>100?"...":""]})]}),r&&u.jsxs("div",{style:{padding:"12px",background:"linear-gradient(135deg, rgba(22, 163, 74, 0.05), rgba(129, 199, 132, 0.05))",border:"2px solid var(--primary)",borderRadius:"12px",marginBottom:"12px"},children:[u.jsx("div",{style:{fontSize:"14px",color:"var(--text-secondary)",marginBottom:"8px"},children:"Ê∑ª‰ªò„É¨„Ç∑„Éî:"}),u.jsxs("div",{style:{fontWeight:700,fontSize:"16px",color:"var(--text)"},children:["üë®‚Äçüç≥ ",r.title]}),u.jsx("div",{style:{fontSize:"13px",color:"var(--text-secondary)",marginTop:"4px"},children:r.description})]}),u.jsxs("div",{style:{textAlign:"right",fontSize:"14px",color:n.length>S?"#f44336":"var(--text-secondary)",marginBottom:"16px"},children:[n.length," / ",S]}),g.length>0&&u.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(120px, 1fr))",gap:"12px",marginBottom:"16px"},children:g.map((d,x)=>u.jsxs("div",{style:{position:"relative",paddingBottom:"100%",borderRadius:"12px",overflow:"hidden",background:"var(--border)"},children:[u.jsx("img",{src:d,alt:`„Éó„É¨„Éì„É•„Éº ${x+1}`,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"cover"}}),u.jsx("button",{onClick:()=>H(x),style:{position:"absolute",top:"4px",right:"4px",background:"rgba(0, 0, 0, 0.6)",border:"none",borderRadius:"50%",width:"28px",height:"28px",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"white"},children:u.jsx(O,{size:18})})]},x))}),i.length<z&&u.jsxs("label",{style:{display:"inline-flex",alignItems:"center",gap:"8px",padding:"10px 16px",background:"var(--background)",border:"2px solid var(--border)",borderRadius:"12px",cursor:"pointer",color:"var(--primary)",fontSize:"14px",fontWeight:500,marginBottom:"16px",transition:"background 0.2s"},onMouseEnter:d=>{d.currentTarget.style.background="var(--border)"},onMouseLeave:d=>{d.currentTarget.style.background="var(--background)"},children:[u.jsx(Z,{size:20}),"ÁîªÂÉè„ÇíËøΩÂä† (",i.length,"/",z,")",u.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:W,style:{display:"none"}})]}),u.jsxs("div",{style:{marginBottom:"20px"},children:[u.jsx("label",{style:{display:"block",fontSize:"14px",color:"var(--text-secondary)",marginBottom:"8px",fontWeight:500},children:"ÂÖ¨ÈñãÁØÑÂõ≤"}),u.jsx("select",{value:y,onChange:d=>p(d.target.value),style:{width:"100%",padding:"12px",border:"2px solid var(--border)",borderRadius:"12px",fontSize:"15px",color:"var(--text)",background:"var(--background)",cursor:"pointer"},children:V.map(d=>u.jsxs("option",{value:d.value,children:[d.label," - ",d.description]},d.value))})]}),L&&u.jsx("div",{style:{padding:"12px",background:"#ffebee",color:"#c62828",borderRadius:"8px",fontSize:"14px",marginBottom:"16px"},children:L}),u.jsx("button",{onClick:G,disabled:T||!n.trim()||n.length>S,style:{width:"100%",padding:"14px",background:T||!n.trim()||n.length>S?"var(--border)":"linear-gradient(135deg, var(--primary), #81c784)",color:"white",border:"none",borderRadius:"12px",fontSize:"16px",fontWeight:600,cursor:T||!n.trim()||n.length>S?"not-allowed":"pointer",transition:"transform 0.2s"},onMouseEnter:d=>{!T&&n.trim()&&n.length<=S&&(d.currentTarget.style.transform="translateY(-2px)")},onMouseLeave:d=>{d.currentTarget.style.transform="translateY(0)"},children:T?"ÊäïÁ®ø‰∏≠...":"ÊäïÁ®ø„Åô„Çã"})]})]})})};export{wt as A,Pt as B,yt as C,ft as D,Ft as E,zt as F,Wt as P,Dt as a,jt as b,It as c,Et as d,Nt as e,Ut as f,ut as g,Tt as h,$t as i,Mt as j,kt as k,C as l,St as m,At as n,qt as o,Lt as p,Rt as q,Ct as r,M as s,Qt as t,Ot as u,_t as v,Bt as w,vt as x,bt as y,xt as z};
