rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // ========================================
    // ユーザープロフィール画像
    // ========================================

    // アバター画像: avatars/{userId}/*
    match /avatars/{userId}/{file=**} {
      // 読み取り: 誰でも可能（公開プロフィール画像）
      allow read: if true;

      // アップロード: 自分のアバターのみ
      // 10MB以下、JPEG/PNG/GIF/WebP形式
      allow create, write: if request.auth != null
                           && request.auth.uid == userId
                           && request.resource.size < 10 * 1024 * 1024
                           && request.resource.contentType in ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

      // 削除: 自分のアバターのみ削除可能
      allow delete: if request.auth != null
                    && request.auth.uid == userId;
    }

    // カバー画像: covers/{userId}/*
    match /covers/{userId}/{file=**} {
      // 読み取り: 誰でも可能（公開プロフィール画像）
      allow read: if true;

      // アップロード: 自分のカバーのみ
      // 10MB以下、JPEG/PNG/GIF/WebP形式
      allow create, write: if request.auth != null
                           && request.auth.uid == userId
                           && request.resource.size < 10 * 1024 * 1024
                           && request.resource.contentType in ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

      // 削除: 自分のカバーのみ削除可能
      allow delete: if request.auth != null
                    && request.auth.uid == userId;
    }

    // ========================================
    // 投稿画像
    // ========================================

    // 投稿画像: posts/{userId}/*
    match /posts/{userId}/{file=**} {
      // 読み取り: 誰でも可能（公開投稿画像）
      allow read: if true;

      // アップロード: 認証済みユーザーのみ（自分のフォルダ）
      // 15MB以下（複数枚対応）、JPEG/PNG/GIF/WebP形式
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.size < 15 * 1024 * 1024
                    && request.resource.contentType in ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

      // 削除: 自分の投稿画像のみ
      allow delete: if request.auth != null
                    && request.auth.uid == userId;
    }

    // ========================================
    // レシピ共有画像
    // ========================================

    // レシピ画像: recipes/{userId}/*
    match /recipes/{userId}/{file=**} {
      // 読み取り: 誰でも可能（公開レシピ画像）
      allow read: if true;

      // アップロード: 認証済みユーザーのみ（自分のフォルダ）
      // 15MB以下、JPEG/PNG/GIF/WebP形式
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.size < 15 * 1024 * 1024
                    && request.resource.contentType in ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

      // 削除: 自分のレシピ画像のみ
      allow delete: if request.auth != null
                    && request.auth.uid == userId;
    }

    // ========================================
    // デフォルト: すべてのパスはアクセス不可
    // ========================================

    // その他のパスは全てアクセス不可
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
